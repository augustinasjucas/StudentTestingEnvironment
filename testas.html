<html>
<style>
	<style>
	body{
		margin: 1%;
	}
	.AllTestsDataHolder{
		width: 90%;
	}
	.MainTable{
		width: 100%;
	}
	.MainTable, .MainTable th, td{
		padding: 0.2%;
		border: 1px solid black;
	}
	.MainTable td, th{
		width: 20%;
	}
	.RemoveQuestion, .ChangeQuestion{
		width: 100%;
	}
</style>
</style>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/mainFunctions.js"></script>
<h1>Testai</h1>
<div class="AllTestsDataHolder" id="AllTestsDataHolder">
	<div class="TestDataHolder" id="TestDataHolder"></div>
	<div class="FullQuestions">
		<div class="TestQuestionsHolder" id="TestQuestionsHolder"></div>
		<div class="BothButtons">
			<button class="CreationButton" onClick="CreateNewClosedQuestion()">Pridėti uždarą klausimą</button>
			<button class="CreationButton" onClick="CreateNewOpenQuestion()">Pridėti atvirą klausimą</button>
		</div>
	</div>
</div>
<script>
	var ThisTest;
	var NumberOfOptions = [];
	var RealIndex = [];
	var IsPressed = [];
	var NewQuestions = new Set();
	var IndexOfThisTest = sessionStorage.getItem('CurrentTest');
	socket.emit('AskForATest', IndexOfThisTest);
	socket.on('GetTheTest', function (data){
		ThisTest = data;
		DisplayThisTest();
	});
	socket.on('NewQuestionToTestAdded', function(data){
		RealIndex[data.pastIndex] = data.newIndex;
		NewQuestions.delete(data.pastIndex);
		IsPressed[data.pastIndex] = false;
	})
	function DisplayThisTest(){
		//DisplayTestData();
		DisplayTestQuestions();
	}
	function DisplayTestQuestions(){
		var Holder = document.getElementById('TestQuestionsHolder');
		var MainTable = CreateTable('QuestionsTable', 'MainTable', [Dictionary['Subject'], Dictionary['Question'], Dictionary['ChoosingOptions'], Dictionary['Answer'], Dictionary['Functions']]);
		for(var i = 0; i < ThisTest.Questions.length; i++){
			if(ThisTest.Questions[i].Hidden == 1) continue;
			var Klausimas;
			if(ThisTest.Questions[i].Type == 'Open') Klausimas = CreateOpen(ThisTest.Questions[i], i);
			if(ThisTest.Questions[i].Type == 'Closed') Klausimas = CreateClosed(ThisTest.Questions[i], i);
			RealIndex[i] = i;
			MainTable.append(Klausimas);
		}
		Holder.append(MainTable);
	}
	function ChangeQuestion(index){
		TransformSubjectHolder(index, ThisTest.Questions[index]);
		TransformQuestionHolder(index, ThisTest.Questions[index]);
		TransformAnswerHolder(index, ThisTest.Questions[index]);
		TransformOptionsHolder(index, ThisTest.Questions[index]);
		TransformFunctionsHolder(index);
		TransformFunctionsHolder(index, ThisTest.Questions[index]);
	}
	function SaveClosedQuestion(index){
		var ThisQuestion = NewClosedQuestionForm();
		ThisQuestion.Subject = document.getElementById('NewSubjectInput'+index).value;
		ThisQuestion.Question = document.getElementById('NewQuestionInput'+index).value;
		ThisQuestion.Answer = ConvertToInt(document.getElementById('NewAnswerInput'+index).value)-1;
		ThisQuestion.Options = GetAllOptions(index);
		if(FitsAsClosed(ThisQuestion)){
			if(NewQuestions.has(index)){
				if(IsPressed[index]) return;
				IsPressed[index] = true;
				ThisTest.Questions[index] = ThisQuestion;
				socket.emit('AddNewQuestionToTest', {question: ThisQuestion, pastIndex: index, testIndex: IndexOfThisTest});
				UpdateClosedQuestion(ThisQuestion, index);
				return;
			}
			socket.emit('EditQuestionInTest', {'questionIndex': RealIndex[index], 'question': ThisQuestion, 'testIndex': IndexOfThisTest});
			ThisTest.Questions[index] = ThisQuestion;
			UpdateClosedQuestion(ThisQuestion, index);
		}else{
			console.log('BLOGAS KLAUSIMAS!!');
		}
	}
	function SaveOpenQuestion(index){
		var ThisQuestion = NewOpenQuestionForm();
		ThisQuestion.Subject = document.getElementById('NewSubjectInput'+index).value;
		ThisQuestion.Question = document.getElementById('NewQuestionInput'+index).value;
		ThisQuestion.Answer = document.getElementById('NewAnswerInput'+index).value;
		if(FitsAsOpen(ThisQuestion)){
			if(NewQuestions.has(index)){
				if(IsPressed[index]) return;
				IsPressed[index] = true;
				ThisTest.Questions[index] = ThisQuestion;
				socket.emit('AddNewQuestionToTest', {question: ThisQuestion, pastIndex: index, testIndex: IndexOfThisTest});
				UpdateOpenQuestion(ThisQuestion, index);
				return;
			}
			socket.emit('EditQuestionInTest', {'index': RealIndex[index], 'question': ThisQuestion, 'testIndex': IndexOfThisTest});
			ThisTest.Questions[index] = ThisQuestion;
			UpdateOpenQuestion(ThisQuestion, index);
		}else{
			console.log('BLOGAS KLAUSIMAS!!');
		}
	}
	function SaveQuestion(index){
		if(ThisTest.Questions[index].Type == 'Closed') SaveClosedQuestion(index);
		if(ThisTest.Questions[index].Type == 'Open') SaveOpenQuestion(index);
	}
	function RemoveQuestion(index){
		ThisTest.Questions[index].Hidden = 1;
		RemoveElementById('QuestionRow'+index);
		if(!NewQuestions.has(index)) socket.emit('DeleteQuestionFromTest', {testIndex: IndexOfThisTest, questionIndex: index});
	}
	function CreateNewClosedQuestion(){
		var index = ThisTest.Questions.length;
		var NewQuestion = NewClosedQuestionForm();
		var Holder = document.getElementById('QuestionsTable');
		ThisTest.Questions.push(NewQuestion);
		Holder.append(CreateClosed(NewQuestion, index));
		ChangeQuestion(index);
		IsPressed[index] = false;
		NewQuestions.add(index);
	}
	function CreateNewOpenQuestion(){
		var index = ThisTest.Questions.length;
		var NewQuestion = NewOpenQuestionForm();
		var Holder = document.getElementById('QuestionsTable');
		ThisTest.Questions.push(NewQuestion);
		Holder.append(CreateOpen(NewQuestion, index));
		ChangeQuestion(index);
		IsPressed[index] = false;
		NewQuestions.add(index);
	}
	
</script>

</html>











































