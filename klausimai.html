<html>
<style>
	body{
		margin: 1%;
	}
	.AllQuestionsHolder{
		width: 90%;
	}
	.MainTable{
		width: 100%;
	}
	.MainTable, .MainTable th, td{
		padding: 0.2%;
		border: 1px solid black;
	}
	.MainTable td, th{
		width: 20%;
	}
	.RemoveQuestion, .ChangeQuestion{
		width: 100%;
	}
</style>
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<h1 class="MainName">Klausimu duomenu baze</h1>
<div class="FullQuestions">
	<div class="AllQuestionsHolder" id="AllQuestionsHolder"></div>
	<div class="BothButtons">
		<button class="CreationButton" onClick="CreateNewClosedQuestion()">Pridėti uždarą klausimą</button>
		<button class="CreationButton" onClick="CreateNewOpenQuestion()">Pridėti atvirą klausimą</button>
	</div>
</div>
<script>
	
	var Dictionary = {};

	Dictionary['QuestionIsOpen'] = 'Klausimas yra atviras';
	Dictionary['EditQuestion'] = 'Redaguoti klausimą';
	Dictionary['Unspecified'] = 'Nenurodytas';
	Dictionary['Question'] = 'Klausimas';
	Dictionary['ChoosingOptions'] = 'Pasirinkimo variantai';
	Dictionary['Answer'] = 'Atsakymas';
	Dictionary['Subject'] = 'Mokomasis dalykas'; 
	Dictionary['Functions'] = 'Funkcijos';
	Dictionary['ToUpdateQuestion'] = 'Redaguoti klausimą';
	Dictionary['ToRemoveQuestion'] = 'Panaikinti klausimą';
	Dictionary['QuestionIsOpen'] = 'Klausimas yra atviras';
	Dictionary['Save'] = 'Išsaugoti';
	
	var AllQuestions = [];			// Global array wiht all questions, which were downloaded from sever
	var NumberOfOptions = [];		// Global array with numbers of choices for each closed question
	var IndicesOfNewQuestions = [];
	var IsPressed = [];
	var RealIndex = [];
	
	var socket = io.connect();
	socket.emit('AskForQuestions');
	socket.on('GetAllQuestions', function(data){
		AllQuestions = data;
		console.log(data);
		LoadAllQuestions();
	});
	socket.on('QuestionSaved', function(data){
	})
	function ConvertToInt(str){
		var Return = 0;
		for(var i = 0; i < str.length; i++){ 
			if(0 <= str[i]-'0' && str[i]-'0' <= 9) Return = Return*10 + (str[i]-'0');
			else {
				Return = -1;
				break;
			}
		}
		return Return;
	}
	function RemoveElementById(id) {
		var elem = document.getElementById(id);
		elem.parentNode.removeChild(elem);
	}
	function GetAnswer(answer, index){
		if(answer == '' && AllQuestions[index].Type == 'Open') return Dictionary['Unspecified'];
		if(answer != '' && AllQuestions[index].Type == 'Open') return answer;
		return answer+1;
	}
	function CreateButton(id, clas, onClick, value){
		var Button = document.createElement('button');
		Button.setAttribute('id', id);
		Button.setAttribute('class', clas);
		Button.setAttribute('onClick', onClick);
		Button.innerHTML = value;
		return Button;
	}
	function CreateTr(id, clas){
		var Tr = document.createElement('tr');
		Tr.setAttribute('id', id);
		Tr.setAttribute('class', clas);
		return Tr;
	}
	function CreateTd(id, clas, value){
		var Td = document.createElement('td');
		Td.setAttribute('id', id);
		Td.setAttribute('class', clas);
		Td.innerHTML = value;
		return Td;
	}
	function CreateDiv(id, clas, value){
		var Div = document.createElement('div');
		Div.setAttribute('id', id);
		Div.setAttribute('class', clas);
		Div.innerHTML = value;
		return Div;
	}
	function CreateBr(id = ''){
		var Br = document.createElement('br');
		return Br;
	}
	function CreateP(id, clas){
		var P = document.createElement('p');
		P.setAttribute('id', id);
		P.setAttribute('class', clas);
		return P;
	}
	function CreateOptionsField(options, index){
		var Return = CreateTd('OptionsField'+index, 'OptionField', '');
		console.log(options);
		for(var i = 0; i < options.length; i++){
			var Div = CreateDiv('', '', (i+1) + ') ' + options[i]);
			if(i != options.length-1) Div.append(CreateBr());
			Return.append(Div);
		}
		return Return;
	}
	function CreateAnswerField(answer, index){
		var Td = CreateTd('AnswerField'+index, 'AnswerField', GetAnswer(answer, index));
		return Td;
	}
	
	function CreateFunctionsField(index){
		var Td = CreateTd('FunctionsField'+index, 'FunctionsField', '');
		Td.append(CreateButton('ChangeQuestion'+index, 'ChangeQuestion', 'ChangeQuestion('+index+')', Dictionary['ToUpdateQuestion']));
		Td.append(CreateBr());
		Td.append(CreateButton('RemoveQuestion'+index, 'RemoveQuestion', 'RemoveQuestion('+index+')', Dictionary['ToRemoveQuestion']));
		
		return Td;
	}
	
	function CreateClosed(question, index){
		var Tr = CreateTr('QuestionRow'+index, 'QuestionRow Open');
		
		var SubjectField = CreateTd('SubjectField'+index, 'SubjectField', question.Subject);
		var QuestionField = CreateTd('QuestionField'+index, 'QuestionField', question.Question);
		var OptionsField = CreateOptionsField(question.Options, index);
		var AnswerField = CreateAnswerField(question.Answer, index);
		var FunctionsField = CreateFunctionsField(index);
		
		Tr.append(SubjectField);
		Tr.append(QuestionField);
		Tr.append(OptionsField);
		Tr.append(AnswerField);
		Tr.append(FunctionsField);
		
		return Tr;
	}
	function CreateOpen(question, index){
		var Tr = CreateTr('QuestionRow'+index, 'QuestionRow Closed');
		
		var SubjectField = CreateTd('SubjectField'+index, 'SubjectField', question.Subject);
		var QuestionField = CreateTd('QuestionField'+index, 'QuestionField', question.Question);
		var OptionsField = CreateTd('OptionsField'+index, 'OptionsField', Dictionary['QuestionIsOpen']);
		var AnswerField = CreateAnswerField(question.Answer, index);
		var FunctionsField = CreateFunctionsField(index);
		
		Tr.append(SubjectField);
		Tr.append(QuestionField);
		Tr.append(OptionsField);
		Tr.append(AnswerField);
		Tr.append(FunctionsField);
		
		return Tr;
	}
	function CreateTable(id, clas, headers){
		var Table = document.createElement('table');
		Table.setAttribute('id', id);
		Table.setAttribute('class', clas);
		
		var tr = CreateTr('TableHeaders', 'TableHeaders');
		
		for(var i = 0; i < headers.length; i++){
			var th = document.createElement('th');
			th.innerHTML = headers[i];
			tr.append(th);
		}
		Table.append(tr);
		return Table;
	}
	function LoadAllQuestions(){
		var Holder = document.getElementById('AllQuestionsHolder');
		var MainTable = CreateTable('MainTable', 'MainTable', [Dictionary['Subject'], Dictionary['Question'], Dictionary['ChoosingOptions'], Dictionary['Answer'], Dictionary['Functions']]);
		
		Holder.append(MainTable);
		for(var i = 0; i < AllQuestions.length; i++){
			if(AllQuestions[i].Hidden == 1) continue;
			if(AllQuestions[i].Type == 'Closed') MainTable.append(CreateClosed(AllQuestions[i], i));
			if(AllQuestions[i].Type == 'Open') MainTable.append(CreateOpen(AllQuestions[i], i));
			RealIndex[i] = i;
			NumberOfOptions.push(-1);
		}
	}
	function CreateTextInput(id, clas, value){
		var Input = document.createElement('input');
		Input.setAttribute('type', 'text');
		Input.setAttribute('id', id);
		Input.setAttribute('class', clas);
		Input.setAttribute('value', value);
		return Input;
	}
	function CreateTextArea(id, clas, value){
		var Input = document.createElement('textarea');
		Input.setAttribute('type', 'text');
		Input.setAttribute('id', id);
		Input.setAttribute('class', clas);
		Input.innerHTML = value;
		return Input;
	}
	function CreateOption(index, i, value){
		var Div = CreateDiv('Option'+index+'-'+i+'ChangeHolder', 'OptionChangeHolder', '');
		Div.append(CreateTextInput('Option'+index+'-'+i+'Change', 'OptionChange', value));
		return Div;
	}
	function AddOption(index){
		if(NumberOfOptions[index] >= 5) return;
		NumberOfOptions[index]++;
		var Holder = document.getElementById('OptionsField'+index);
		Holder.append(CreateOption(index, NumberOfOptions[index]-1, ''));
	}
	function RemoveOption(index){
		if(NumberOfOptions[index] <= 2) return;
		NumberOfOptions[index]--;
		RemoveElementById('Option'+index+'-'+NumberOfOptions[index]+'ChangeHolder');
	}
	function TransformSubjectHolder(index){
		var Holder = document.getElementById('SubjectField'+index);
		Holder.innerHTML = '';
		Holder.append(CreateTextInput('NewSubjectInput'+index, 'NewSubjectInput', AllQuestions[index].Subject));
	}
	function TransformQuestionHolder(index){
		var Holder = document.getElementById('QuestionField'+index);
		Holder.innerHTML = '';
		Holder.append(CreateTextInput('NewQuestionInput'+index, 'NewQuestionInput', AllQuestions[index].Question));
	}
	function TransformAnswerHolder(index){
		var Holder = document.getElementById('AnswerField'+index);
		Holder.innerHTML = '';
		if(AllQuestions[index].Type == 'Closed') Holder.append(CreateTextInput('NewAnswerInput'+index, 'NewAnswerInput', AllQuestions[index].Answer+1));
		if(AllQuestions[index].Type == 'Open') Holder.append(CreateTextArea('NewAnswerInput'+index, 'NewAnswerInput', AllQuestions[index].Answer));
	}
	function TransformFunctionsHolder(index){
		var RemoveButton = document.getElementById('RemoveQuestion'+index);
		var ChangeButton = document.getElementById('ChangeQuestion'+index);
		RemoveButton.setAttribute('onClick', 'RemoveQuestion('+index+')');
		ChangeButton.setAttribute('onClick', 'SaveQuestion('+index+')');
		ChangeButton.innerHTML = Dictionary['Save'];
	}
	function TransformOptionsHolder(index){
		if(AllQuestions[index].Type == 'Open') return;
		var OptionsHolder = document.getElementById('OptionsField'+index);
		OptionsHolder.innerHTML = '';
		OptionsHolder.append(CreateButton('AddOption'+index, 'AppOption', 'AddOption('+index+')', '+'));
		OptionsHolder.append(CreateButton('RemoveOption'+index, 'RemoveOption', 'RemoveOption('+index+')', '-'));
		NumberOfOptions[index] = AllQuestions[index].Options.length;
		
		for(var i = 0; i < AllQuestions[index].Options.length; i++){
			OptionsHolder.append(CreateOption(index, i, AllQuestions[index].Options[i]));
		}
	}
	function ChangeQuestion(index){
		TransformSubjectHolder(index);
		TransformQuestionHolder(index);
		TransformAnswerHolder(index);
		TransformOptionsHolder(index);
		TransformFunctionsHolder(index);
		TransformFunctionsHolder(index);
	}
	function GetAllOptions(index){
		var Return = [];
		for(var i = 0; i < NumberOfOptions[index]; i++){
			Return.push(document.getElementById('Option'+index+'-'+i+'Change').value);
		}
		return Return;
	}
	function FitsAsClosed(question){
		var Fits = true;
		for(var i = 0; i < question.Options.length; i++){
			if(question.Options[i] == '') Fits = false;
			for(var j = i+1; j < question.Options.length; j++){
				Fits = Fits && (question.Options[i] != question.Options[j]);
			}
		}
		Fits = Fits && (question.Answer >= 0 && question.Answer < question.Options.length);
		Fits = Fits && (question.Subject != '');
		Fits = Fits && (question.Question != '');
		return Fits;
	}
	function FitsAsOpen(question){
		var Fits = true;
		Fits = Fits && (question.Subject != '');
		Fits = Fits && (question.Question != '');
		return Fits
	}
	function UpdateClosedQuestion(question, index){
		var Tr = document.getElementById('QuestionRow'+index);
		Tr.innerHTML = '';
		var SubjectField = CreateTd('SubjectField'+index, 'SubjectField', question.Subject);
		var QuestionField = CreateTd('QuestionField'+index, 'QuestionField', question.Question);
		var OptionsField = CreateOptionsField(question.Options, index);
		var AnswerField = CreateAnswerField(question.Answer, index);
		var FunctionsField = CreateFunctionsField(index);
		
		Tr.append(SubjectField);
		Tr.append(QuestionField);
		Tr.append(OptionsField);
		Tr.append(AnswerField);
		Tr.append(FunctionsField);
	}
	function NewClosedQuestionForm(){
		return {Hidden: 0, Type: 'Closed', Subject: '', Question:'', Answer:0, Options:['', '']};
	}
	function NewOpenQuestionForm(){
		return {Hidden: 0, Type: 'Open', Subject: '', Question:'', Answer:''};
	}
	function UpdateOpenQuestion(question, index){
		var Tr = document.getElementById('QuestionRow'+index);
		Tr.innerHTML = '';
		var SubjectField = CreateTd('SubjectField'+index, 'SubjectField', question.Subject);
		var QuestionField = CreateTd('QuestionField'+index, 'QuestionField', question.Question);
		var OptionsField = CreateTd('OptionsField'+index, 'OptionsField', Dictionary['QuestionIsOpen']);
		var AnswerField = CreateAnswerField(question.Answer, index);
		var FunctionsField = CreateFunctionsField(index);
		
		Tr.append(SubjectField);
		Tr.append(QuestionField);
		Tr.append(OptionsField);
		Tr.append(AnswerField);
		Tr.append(FunctionsField);
	}
	function QuestionIsNew(index){
		var Return = false;
		for(var i = 0; i < IndicesOfNewQuestions.length; i++){
			if(IndicesOfNewQuestions[i] == index) Return = true;
		}
		return Return;
	}
	function DeleteFromNew(index){
		for(var i = 0; i < IndicesOfNewQuestions.length; i++){
			if(IndicesOfNewQuestions[i] == index){
				IndicesOfNewQuestions.splice(i, 1);
				break;
			} ///// Kas jei per daug pridedame?? 
		}
	}

	socket.on('SavedNewQuestion', function (data){
		var NewIndex = data.newIndex;
		var OldIndex = data.oldIndex;
		DeleteFromNew(OldIndex);
		IsPressed[OldIndex] = false;
		RealIndex[OldIndex] = NewIndex
	});
	function SaveClosedQuestion(index){
		var ThisQuestion = NewClosedQuestionForm();
		ThisQuestion.Subject = document.getElementById('NewSubjectInput'+index).value;
		ThisQuestion.Question = document.getElementById('NewQuestionInput'+index).value;
		ThisQuestion.Answer = ConvertToInt(document.getElementById('NewAnswerInput'+index).value)-1;
		ThisQuestion.Options = GetAllOptions(index);
		if(FitsAsClosed(ThisQuestion)){
			if(QuestionIsNew(index) && !IsPressed[index]){
				IsPressed[index] = true;
				AllQuestions[index] = ThisQuestion;
				socket.emit('AddNewQuestion', {question: ThisQuestion, pastIndex: index});
				UpdateClosedQuestion(ThisQuestion, index);
				return;
			}
			socket.emit('EditQuestion', {'index': RealIndex[index], 'question': ThisQuestion});
			AllQuestions[index] = ThisQuestion;
			UpdateClosedQuestion(ThisQuestion, index);
		}else{
			console.log('BLOGAS KLAUSIMAS!!');
		}
	}
	function SaveOpenQuestion(index){
		var ThisQuestion = NewOpenQuestionForm();
		ThisQuestion.Subject = document.getElementById('NewSubjectInput'+index).value;
		ThisQuestion.Question = document.getElementById('NewQuestionInput'+index).value;
		ThisQuestion.Answer = document.getElementById('NewAnswerInput'+index).value;
		if(FitsAsOpen(ThisQuestion)){
			if(QuestionIsNew(index) && !IsPressed[index]){
				AllQuestions[index] = ThisQuestion;
				IsPressed[index] = true;
				socket.emit('AddNewQuestion', {question: ThisQuestion, pastIndex: index});
				UpdateOpenQuestion(ThisQuestion, index);
				return;
			}
			socket.emit('EditQuestion', {'index': RealIndex[index], 'question': ThisQuestion});
			AllQuestions[index] = ThisQuestion;
			UpdateOpenQuestion(ThisQuestion, index);
		}else{
			console.log('BLOGAS KLAUSIMAS!!');
		}
	}
	function SaveQuestion(index){
		if(AllQuestions[index].Type == 'Closed') SaveClosedQuestion(index);
		if(AllQuestions[index].Type == 'Open') SaveOpenQuestion(index);
	}
	function RemoveQuestion(index){
		RemoveElementById('QuestionRow'+index);
		if(!QuestionIsNew(index))socket.emit('RemoveQuestion', RealIndex[index]);
	}
	function CreateNewClosedQuestion(){
		var index = AllQuestions.length;
		var NewQuestion = NewClosedQuestionForm();
		var Holder = document.getElementById('MainTable');
		IndicesOfNewQuestions.push(index);
		AllQuestions.push(NewQuestion);
		Holder.append(CreateClosed(NewQuestion, index));
		ChangeQuestion(index);
	}
	function CreateNewOpenQuestion(){
		var index = AllQuestions.length;
		var NewQuestion = NewOpenQuestionForm();
		var Holder = document.getElementById('MainTable');
		IndicesOfNewQuestions.push(index);
		AllQuestions.push(NewQuestion);
		Holder.append(CreateOpen(NewQuestion, index));
		ChangeQuestion(index);
	}
	
</script>

</html>
